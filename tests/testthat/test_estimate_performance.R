context("estimate_performance()")

scores <- c(1.28894596962271, 1.50181927269732, 1.44693803951615, 1.16009426045129,
            1.74882110462975, 1.79360698188156, 1.51280469440096, 1.50805664249018,
            1.29229627527031, 1.7924982026502, 1.66937147922831, 2.31064192182611,
            1.47397210477938, 1.93300282667523, 2.6351807071264, 1.86415877207356,
            1.79839024169764, 2.99997750629226, 3.36347027820246, 1.4709071755747,
            0.821382717864989, 2.47196081895639, 1.5096953650198, 1.41312280665636,
            1.71787328522884, 2.43811276903357, 1.76530591118093, 1.93272583800077,
            2.28747829140223, 1.80117212074219, 1.99357886008381, 2.1862947074508,
            1.56060992464915, 1.37420888553336, 2.04296902269177, 1.68284806574963,
            2.99167911819838, 1.73738565667259, 2.1282702741587, 1.17783577234626,
            1.91443138092018, 2.33453813939249, 1.58773101098397, 2.81992632195662,
            2.21862628205439, 1.92858763507148, 2.49530369210356, 2.50640432583649,
            2.33346708042866, 1.20918971062301, 2.20721853958813, 1.87634319540679,
            0.960045453624525, 2.03720530181463, 2.88687205615347, 1.33594311296816,
            2.2480868320095, 1.74826330147061, 2.13230479301329, 2.29489396427187,
            1.95726302974194, 1.926807441719, 2.07858187314961, 2.02250658128781,
            1.60513231735667, 1.44098875060511, 1.92239376839256, 2.00160740210477,
            1.36263748677937, 2.19533054367868, 1.95544695156082, 2.30282535304318,
            2.08298391062446, 1.59704242636155, 2.51424749033323, 2.01802472704247,
            2.25045262658533, 2.00160158205471, 2.70478505531689, 2.68341081371562,
            2.75800598174513, 1.74186502145799, 1.82852516474719, 1.24529753257183,
            1.80498480061351, 2.2013254976232, 1.89826698947014, 1.98841040082169,
            1.8239281773403, 1.72353713097985, 1.68433812475307, 2.14088289611465,
            1.14466748682128, 1.80286719179824, 1.68480972763758, 1.17787549232535,
            2.69371515522984, 2.0736399936351, 1.80038559929702, 1.0671901993617,
            1.67118364103582, 1.76235719929576, 1.38371820411254, 2.17406930377742,
            1.55971070408022, 2.18811008733011, 1.73112466861479, 2.49091285471895,
            1.42165678023575, 1.92896237578536, 2.16081237373743, 1.31941381248669,
            1.91247166435763, 2.15071352850746, 2.35669346388184, 1.6074368138983,
            1.95110366694674, 1.71838127604546, 2.17262747729455, 2.09045428366483,
            3.21036531096907, 1.69488557317277, 1.71274937092634, 1.59930276109405,
            2.02200424161718, 1.65667402589867, 1.40837591045312, 2.97031690554493,
            1.54433706792433, 2.35025398062313, 2.43611629154155, 1.09520372606215,
            1.97758238113798, 1.61939394056976, 2.04579009352137, 1.98744036338101,
            1.52321415988459, 1.68589442907767, 1.51843756734192, 1.67283469936741,
            1.20143982626412, 1.32322054433344, 1.78161183406988, 1.47507595667299,
            2.28819451956328, 1.34525238762756, 1.41245539150431, 1.14469834569455,
            2.5561875516863, 2.65469092030222, 1.56806262880164, 2.1572442163327,
            3.06402910209619, 1.56239346408784, 1.3684853587371, 2.2712603665895,
            1.44319875665476, 1.95781436318797, 2.79221808901969, 1.42162454029485,
            1.94417375153665, 1.67894241024957, 2.29428234101673, 1.66361410661926,
            2.19022588811046, 1.20535553185778, 1.92889965201962, 2.14748239457764,
            1.650261142375, 1.8175999113857, 1.7334564940385, 1.00198739581263,
            1.88427822334624, 1.50202627855062, 2.32970435640702, 2.31907732295078,
            2.65120488622251, 1.377674542454, 1.57294214030662, 1.95342771553848,
            2.10347271705446, 2.90562299398771, 1.64912451724639, 1.94129980658147,
            2.13987453039472, 2.44575004246565, 1.70425026781921, 1.6429083504558,
            1.84983758109951, 0.972856746463321, 2.20964694709622, 2.8466700621106,
            1.70292585944572, 1.73202326536642, 1.55579769401717, 2.16845140501801,
            1.40323169143288, 1.46669283719262, 2.03287077949637, 2.25199615667598,
            2.57187232150889, 1.538852100476, 1.88417594754928, 1.5971429483052,
            1.61439418093161, 1.46970696748313, 1.38569269812832, 1.45992656714038,
            2.31024757600992, 1.89341633987574, 1.65739691562776, 1.39402156280289,
            3.4329612588219, 1.18838071429822, 1.49426058221983, 1.52980975503733,
            2.38104952840252, 2.02268758052016, 1.48991402596833, 1.51243600553551,
            1.40913457593157, 1.75938378786232, 1.27202561645558, 1.53018426302959,
            1.45259534268849, 1.31175859775421, 2.04556016559789, 1.24082168657732,
            2.1268619678188, 1.20765691610402, 2.98150736158745, 2.04217482001957,
            1.37913054512263, 1.66082017185524, 2.00518258540472, 1.48011675996433,
            1.78896174601295, 1.806768264168, 1.38074029961324, 1.67343871753361,
            1.71857164872467, 2.57043780058073, 1.6487940824877, 2.10490138361755,
            3.23053012830562, 3.50264974766047, 1.87935686934723, 1.88979740400459,
            1.55499429884024, 1.29553839487007, 0.978306041997573, 1.09826518577267,
            1.32718941377533, 1.2289184653796, 1.51551980242687, 1.65975262807806,
            2.0608235589583, 1.94788700057153, 1.53477246460795, 1.50470012554407,
            1.25305006711308, 1.97304282661508, 2.37618010856983, 1.0855918930066,
            1.73473355023557, 2.64986127701162, 2.05661028597073, 1.78995898584842,
            1.70104607069774, 1.49195476711057, 1.82689632100739, 1.6593496226056,
            1.9318773979291, 2.33608181509557, 2.15258455045213, 1.40285278715394,
            2.0334412586593, 2.49107287167378, 2.18228205883802, 1.32894055658152,
            2.24149074023187, 1.22611775776596, 1.24596817775383, 1.39056120900662,
            3.17256148080458, 1.25035608391547, 2.83000398062682, 2.51921504125841,
            1.8860507723777, 1.94638684253919, 1.72319364446096, 2.630777686279,
            1.5840789554352, 1.62193922428541, 1.63869329840292, 1.93616623558653,
            1.56670986540414, 1.89823595116506, 2.38057637823132, 2.01511428836941,
            2.04821220299674, 2.05781902408662, 1.77573470962592, 1.44696698499997,
            2.0206728258843, 1.35440580470348, 1.90068649261295, 2.09639926817832,
            2.25677778820072, 1.41355424855408, 2.23154075134801, 1.76977823788785,
            1.37866752023313, 2.65933223568696, 2.03301381591284, 2.32821056006661,
            1.80835445080287, 1.40853394094695, 1.31965103052049, 1.4682908604774,
            1.93818714296015, 1.54299938700163, 1.77708454240769, 1.22491151772326,
            2.31694194391378, 1.7602994190207, 1.98378335240925, 1.79089866267696,
            1.65642904751944, 1.53863888168346, 1.76458320937088, 2.24580793094111,
            1.54389413111159, 1.71680404283946, 1.38171695675977, 1.14535355276338,
            3.18581826694397, 1.96607498250883, 1.40482499690116, 2.87029941027335,
            1.40941393738787, 2.33901982242857, 1.97250119879198, 1.91389754397619,
            2.41310122132721, 1.62047707176327, 1.62678904702525, 1.8729410394665,
            1.28229619179962, 2.01645297751674, 1.28869225846277, 1.4357966089462,
            3.36031900453963, 1.25469015774014, 2.67689056215606, 1.5439909080954,
            1.85868769346936, 1.48578816460203, 0.990712521827336, 2.90952616577559,
            1.79320192384982, 1.33431066403689, 1.55349310623994, 1.51746473458563,
            1.49309957453915, 1.57985859523136, 3.05208189148641, 1.76114715319958,
            1.63236370281147, 1.76383371370356, 1.78721165597246, 1.71967472045186,
            0.98340577729651, 2.09250385961731, 1.60533585113842, 2.09880180405799,
            1.97282691237967, 2.15285624136438, 0.958659289061971, 1.74879310622728,
            1.55926189571244, 0.87291959971293, 1.64273880755012, 2.21409753023118,
            1.68769885644952, 1.61738821326416, 2.21503350991974, 1.55161554800192,
            2.07973946135024, 1.7361524888822, 1.54791111743836, 2.78171899469652,
            2.02778000954268, 2.82679883848342, 2.16691444426149, 2.0842782836436,
            2.02386942918077, 1.46295084694282, 1.41039357718577, 1.37512666943827,
            2.49742379871736, 1.63278417650731, 2.49711857987209, 2.62271250118276,
            2.19064846358908, 1.84989887294999, 2.31286000281909, 1.86620312404877,
            2.03719063937054, 2.41612940129863, 1.86333271324245, 1.40985707022286,
            1.37888009129079, 1.47947445792083, 1.98414681274161, 3.01336277292071,
            1.89503010257032, 2.66980956995658, 0.858560108309384, 1.38880693734689,
            2.74508432636923, 1.8717980450546, 2.88653749185388, 1.73366503657919,
            2.13490483222162, 1.60555354781489, 1.78945689528293, 1.81384790436421,
            1.33631564786018, 2.35027215673818, 1.36849824999683, 1.71247256848612,
            1.796445501003, 1.70258951937845, 2.41182071517731, 2.16109786876274,
            3.07728222663187, 2.01405995567759, 1.58475181695858, 2.40425306693768,
            2.90733577521818, 3.1167170097518, 1.44953877668112, 2.95891496242148,
            1.9779334881852, 1.48310601364045, 1.67185448851377, 2.27295035154797,
            1.44502248416765, 1.5868181504269, 1.64072546934755, 1.98276059510423,
            1.96530643632691, 1.33752294825445, 1.30137129248731, 1.64265519767025,
            2.00839757250947, 1.67872698657159, 2.67747228285908, 1.86824873433441,
            2.29242493080004, 1.51615249594742, 1.78211180781194, 2.64148569653552,
            1.79181917770909, 1.47728146280396, 1.75739243572316, 1.32863686250476,
            1.3268895818364, 1.33452244849659, 1.97235221997075, 1.6324005208413,
            1.59734606485763, 2.95045027875198, 1.90923621890969, 1.50856893884471,
            1.82345395174045, 2.34372504080331, 2.36296740931177, 1.65144952814584,
            2.18795741807279, 1.56434098268535, 2.09226350152788, 2.37277939491552,
            1.69857783740618, 0.95344403293173, 2.02511106935612, 2.61023787400484,
            1.60238618828655, 1.85932656956624, 2.21380014465088, 1.8839973751722,
            2.17295013315204, 2.81473505486019, 2.06065446183566, 1.3157213089336,
            2.11475388615525, 2.4179279500768, 1.89952778098967, 1.26937879129535
)

# calculate the identification rate implied by the system parameters
id.rate <- 0.03240091

# calculate the nomination rate implied by the system parameters
nom.rate <- 0.1

expect_warning(estimate_performance(scores=scores, id.rate=id.rate,
                                    nom.rate=nom.rate, reps=3))

set.seed(123)
a <- estimate_performance(scores=scores, id.rate=id.rate,
                          nom.rate=nom.rate, reps=500, ncpus=4, parallel="multicore")

expect_equal(unlist(a$summary),
             structure(c(0.90902, 0.94139, 0.53699, 0.31914, 0.10827, 0.32495,
                         0.9, 0.1, 0.03249, 0.00424, 0.01718, 0.0215, 0.01504, 0.01428,
                         0.00517, NA, NA, NA, 0.90072, 0.90773, 0.49485, 0.28966, 0.08028,
                         0.31481, NA, NA, NA, 0.91733, 0.97506, 0.57913, 0.34863, 0.13627,
                         0.33509, NA, NA, NA), .Names = c("Estimate1", "Estimate2", "Estimate3",
                                                          "Estimate4", "Estimate5", "Estimate6", "Estimate7", "Estimate8",
                                                          "Estimate9", "StdErr1", "StdErr2", "StdErr3", "StdErr4", "StdErr5",
                                                          "StdErr6", "StdErr7", "StdErr8", "StdErr9", "CI.95.lower1", "CI.95.lower2",
                                                          "CI.95.lower3", "CI.95.lower4", "CI.95.lower5", "CI.95.lower6",
                                                          "CI.95.lower7", "CI.95.lower8", "CI.95.lower9", "CI.95.upper1",
                                                          "CI.95.upper2", "CI.95.upper3", "CI.95.upper4", "CI.95.upper5",
                                                          "CI.95.upper6", "CI.95.upper7", "CI.95.upper8", "CI.95.upper9")),
             tolerance=1e-2)
